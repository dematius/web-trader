<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>WEB TRADER MENU ‚Äî Full</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
/* ========================
   FULL STYLE SHEET
   ======================== */

:root{
  --bg: #0b0f13;
  --panel: #11161c;
  --line: #2a313a;
  --accent: #8b2436;
  --text: #e6e6e6;
  --muted: #9aa0aa;
  --danger: #b33a3a;
  --neon: #ffee00;
}

/* Reset & base */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
body *{user-select:none} /* globally block text selection */
input,textarea,select{user-select:text} /* allow selection for form fields */

/* Header */
header{
  position:sticky;
  top:0;
  background: linear-gradient(180deg,#0f1317,#090b0d);
  border-bottom:1px solid var(--line);
  z-index:120;
}
.header-row{
  display:flex;
  gap:10px;
  align-items:center;
  padding:12px 16px;
  flex-wrap:wrap;
}
#adminBtn{padding:8px 12px;border-radius:6px;background:#222;color:#fff;border:1px solid var(--line);cursor:pointer}
.title{flex:1;text-align:center;font-weight:800;font-size:20px}
.header-controls{display:flex;gap:8px;align-items:center}

/* Search & player currency */
#search{width:320px;padding:8px 10px;border-radius:6px;background:var(--bg);border:1px solid var(--line);color:var(--text)}
#playerCurrency{padding:8px;border-radius:6px;background:var(--bg);border:1px solid var(--line);color:var(--text)}

/* Trader tabs */
#traderTabs{display:flex;gap:8px;padding:10px 12px;border-top:1px solid rgba(255,255,255,0.02);border-bottom:1px solid var(--line);overflow:auto;background:#0d1114}
.trader-tab{padding:8px 14px;border-radius:8px;background:#12161a;border:1px solid var(--line);cursor:pointer;white-space:nowrap}
.trader-tab.active{background:var(--accent);color:#fff;box-shadow:0 6px 18px rgba(139,36,54,0.12)}

/* Main layout */
.container{padding:16px}
.row{display:flex;gap:12px;align-items:center}

/* Category accordion */
.category{border:1px solid var(--line);border-radius:8px;margin-bottom:12px;overflow:hidden;background:#0f1418}
.category-head{display:flex;justify-content:space-between;padding:12px;cursor:pointer;background:#11151a;border-bottom:1px solid rgba(255,255,255,0.02)}
.category-body{display:none;padding:12px;background:#0c0f12}

/* Category title left (emoji + name) */
.cat-left { display:flex; align-items:center; gap:8px; }
.cat-icon { font-size:18px; opacity:0.95; }

/* Products */
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.card{background:#0b0d11;border:1px solid #1f2428;border-radius:8px;padding:10px;display:flex;flex-direction:column;align-items:center;gap:8px;transition:box-shadow .18s,border-color .18s}
.card img{width:100%;height:120px;object-fit:contain;border-radius:6px;background:#000}
.card .name{font-weight:700;text-align:center}
.card .price{display:flex;gap:8px;justify-content:center;font-weight:700}
.card.highlight{border-color:var(--neon);box-shadow:0 0 12px rgba(255,238,0,0.45)}

/* BUY / SELL styles */
.price-sell{color:#44ff88;font-weight:800}
.price-buy{color:#ff6666;font-weight:800}
.price-sep{opacity:.5}

/* Admin inline panel */
#adminPanelInline{display:none;padding:12px;border-bottom:1px solid var(--line);background:#0d1114}
.admin-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
.admin-card{background:#0e1316;border:1px solid var(--line);padding:10px;border-radius:8px}
.admin-card h4{margin-bottom:8px;color:var(--muted)}
.admin-row{display:flex;gap:8px;align-items:center}
.admin-card label{display:block;font-size:13px;color:var(--muted);margin-top:6px}
.admin-card input, .admin-card select, .admin-card textarea{width:100%;padding:8px;margin-top:6px;background:#0b0f13;border:1px solid var(--line);color:var(--text);border-radius:6px}
.btn{padding:8px 10px;border-radius:6px;border:none;cursor:pointer;background:#222;color:var(--text)}
.btn.primary{background:var(--accent)}
.btn.danger{background:var(--danger)}
.note{font-size:13px;color:#889;margin-top:8px}

/* Login modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:200}
.modal .panel{background:#0f1418;border:1px solid var(--line);padding:16px;border-radius:8px;width:320px}

/* Responsive */
@media(max-width:900px){
  #search{display:none}
  .products{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
}
@media(max-width:480px){
  .products{grid-template-columns:repeat(1,1fr)}
  .admin-grid{grid-template-columns:1fr}
  header .header-row{padding:8px}
}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="header-row">
    <button id="adminBtn" class="btn">ADMIN</button>
    <div class="title">WEB TRADER MENU</div>
    <div class="header-controls">
      <input id="search" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." />
      <select id="playerCurrency" title="–§–∏–ª—å—Ç—Ä –ø–æ –≤–∞–ª—é—Ç–µ">
        <option value="ALL">–í—Å–µ –≤–∞–ª—é—Ç—ã</option>
        <option value="UAH">‚Ç¥ –ì—Ä–∏–≤–Ω—ã (UAH)</option>
        <option value="EUR">‚Ç¨ –ï–≤—Ä–æ (EUR)</option>
        <option value="USD">$ –î–æ–ª–ª–∞—Ä—ã (USD)</option>
      </select>
    </div>
  </div>

  <div id="traderTabs" aria-label="Traders"></div>
</header>

<!-- ADMIN INLINE PANEL -->
<div id="adminPanelInline" aria-hidden="true">
  <div class="admin-grid">

    <div class="admin-card">
      <h4>–°–æ–∑–¥–∞—Ç—å —Ç—Ä–µ–π–¥–µ—Ä–∞</h4>
      <label>–ò–º—è —Ç—Ä–µ–π–¥–µ—Ä–∞</label>
      <input id="newTraderName" type="text" placeholder="–ò–º—è —Ç—Ä–µ–π–¥–µ—Ä–∞" />
      <div style="margin-top:8px"><button id="createTraderBtn" class="btn primary">–°–æ–∑–¥–∞—Ç—å</button></div>
    </div>

    <div class="admin-card">
      <h4>–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h4>
      <label>–¢—Ä–µ–π–¥–µ—Ä</label>
      <select id="selectTraderForCategory"></select>

      <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
      <input id="newCategoryName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" />

      <label>–°–º–∞–π–ª–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
      <select id="newCategoryEmoji">
	  <option value="‚ò¢Ô∏è">‚ò¢Ô∏è –†–∞–¥–∏–∞—Ü–∏—è</option>
	  <option value="‚ö†Ô∏è">‚ö†Ô∏è –û–ø–∞—Å–Ω–æ</option>
	  <option value="‚ò£Ô∏è">‚ò£Ô∏è –ë–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —É–≥—Ä–æ–∑–∞</option>
	  <option value="üí•">üí• –í–∑—Ä—ã–≤</option>
	  <option value="üî•">üî• –û–≥–æ–Ω—å</option>
	  <option value="üå´Ô∏è">üå´Ô∏è –¢—É–º–∞–Ω</option>
	  <option value="üå™Ô∏è">üå™Ô∏è –ê–Ω–æ–º–∞–ª–∏—è</option>
	  <option value="‚ö°">‚ö° –≠–ª–µ–∫—Ç—Ä–∞</option>
	  <option value="üåÄ">üåÄ –ò—Å–∫–∞–∂–µ–Ω–∏–µ</option>
	  <option value="üß™">üß™ –•–∏–º–∏—è</option>
	  <option value="üß´">üß´ –†–µ–∞–≥–µ–Ω—Ç—ã</option>
	  <option value="‚ò†Ô∏è">‚ò†Ô∏è –°–º–µ—Ä—Ç—å</option>
	  <option value="üíÄ">üíÄ –ß–µ—Ä–µ–ø</option>
	  <option value="üß¨">üß¨ –ú—É—Ç–∞—Ü–∏–∏</option>
	  <option value="üï≥Ô∏è">üï≥Ô∏è –ü—Ä–æ–≤–∞–ª</option>
	  <option value="üî´">üî´ –û–≥–Ω–µ—Å—Ç—Ä–µ–ª</option>
	  <option value="üí£">üí£ –í–∑—Ä—ã–≤—á–∞—Ç–∫–∞</option>
	  <option value="üß®">üß® –î–µ—Ç–æ–Ω–∞—Ç–æ—Ä</option>
	  <option value="ü™ì">ü™ì –•–æ–ª–æ–¥–Ω–æ–µ –æ—Ä—É–∂–∏–µ</option>
	  <option value="üî™">üî™ –ù–æ–∂–∏</option>
	  <option value="üèπ">üèπ –ê—Ä–±–∞–ª–µ—Ç—ã</option>
	  <option value="üéØ">üéØ –ü—Ä–∏—Ü–µ–ª</option>
	  <option value="üî≠">üî≠ –û–ø—Ç–∏–∫–∞</option>
	  <option value="üìå">üìå –ú–∏–Ω—ã</option>
	  <option value="üß±">üß± –£–∫—Ä—ã—Ç–∏—è</option>
	  <option value="üõ°Ô∏è">üõ°Ô∏è –ë—Ä–æ–Ω—è</option>
	  <option value="ü•æ">ü•æ –û–±—É–≤—å</option>
	  <option value="üéí">üéí –†—é–∫–∑–∞–∫–∏</option>
	  <option value="ü™ñ">ü™ñ –®–ª–µ–º—ã</option>
	  <option value="üß§">üß§ –ü–µ—Ä—á–∞—Ç–∫–∏</option>
	  <option value="ü¶∫">ü¶∫ –ó–∞—â–∏—Ç–∞</option>
	  <option value="üëï">üëï –ö–æ—Å—Ç—é–º—ã</option>
	  <option value="ü•Ω">ü•Ω –û—á–∫–∏</option>
	  <option value="üéΩ">üéΩ –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞</option>
	  <option value="ü™¢">ü™¢ –†–µ–º–Ω–∏</option>
	  <option value="üíä">üíä –¢–∞–±–ª–µ—Ç–∫–∏</option>
	  <option value="üíâ">üíâ –ò–Ω—ä–µ–∫—Ü–∏–∏</option>
	  <option value="ü©∏">ü©∏ –ö—Ä–æ–≤—å</option>
	  <option value="ü©π">ü©π –ê–ø—Ç–µ—á–∫–∏</option>
	  <option value="üß¥">üß¥ –ê–Ω—Ç–∏—Å–µ–ø—Ç–∏–∫</option>
	  <option value="ü´Ä">ü´Ä –û—Ä–≥–∞–Ω—ã</option>
	  <option value="ü´Å">ü´Å –î—ã—Ö–∞–Ω–∏–µ</option>
	  <option value="ü¶†">ü¶† –ò–Ω—Ñ–µ–∫—Ü–∏–∏</option>
	  <option value="‚òï">‚òï –°—Ç–∏–º—É–ª—è—Ç–æ—Ä—ã</option>
	  <option value="üçñ">üçñ –ú—è—Å–æ</option>
	  <option value="ü•´">ü•´ –ö–æ–Ω—Å–µ—Ä–≤—ã</option>
	  <option value="üçû">üçû –•–ª–µ–±</option>
	  <option value="üçé">üçé –ü—Ä–æ–≤–∏–∑–∏—è</option>
	  <option value="üç∫">üç∫ –ê–ª–∫–æ–≥–æ–ª—å</option>
	  <option value="ü•§">ü•§ –ù–∞–ø–∏—Ç–∫–∏</option>
	  <option value="üßÉ">üßÉ –í–æ–¥–∞</option>
	  <option value="‚ò¢Ô∏èüçñ">‚ò¢Ô∏èüçñ –ó–∞—Ä–∞–∂—ë–Ω–Ω–∞—è –µ–¥–∞</option>
	  <option value="üê∫">üê∫ –í–æ–ª–∫–∏</option>
	  <option value="üêó">üêó –ö–∞–±–∞–Ω—ã</option>
	  <option value="üêï">üêï –ü—Å—ã</option>
	  <option value="ü¶¥">ü¶¥ –¢—Ä–æ—Ñ–µ–∏</option>
	  <option value="üßü">üßü –ú—É—Ç–∞–Ω—Ç—ã</option>
	  <option value="üëπ">üëπ –ú–æ–Ω—Å—Ç—Ä—ã</option>
	  <option value="ü¶∑">ü¶∑ –ß–∞—Å—Ç–∏ –º—É—Ç–∞–Ω—Ç–æ–≤</option>
	  <option value="üëÅÔ∏è">üëÅÔ∏è –ù–∞–±–ª—é–¥–µ–Ω–∏–µ</option>
	  <option value="üèöÔ∏è">üèöÔ∏è –ó–∞–±—Ä–æ—à–∫–∏</option>
	  <option value="üè≠">üè≠ –ó–∞–≤–æ–¥—ã</option>
	  <option value="üè¢">üè¢ –ü—Ä–∏–ø—è—Ç—å</option>
	  <option value="üå≤">üå≤ –õ–µ—Å</option>
	  <option value="ü™®">ü™® –ë–æ–ª–æ—Ç–∞</option>
	  <option value="üõ£Ô∏è">üõ£Ô∏è –î–æ—Ä–æ–≥–∏</option>
	  <option value="üöß">üöß –ë–ª–æ–∫–ø–æ—Å—Ç</option>
	  <option value="‚õìÔ∏è">‚õìÔ∏è –ó–∞–∫—Ä—ã—Ç—ã–µ –∑–æ–Ω—ã</option>
	  <option value="‚öôÔ∏è">‚öôÔ∏è –†–∞–∑–Ω–æ–µ</option>
	  <option value="üî©">üî© –î–µ—Ç–∞–ª–∏</option>
	  <option value="üß∞">üß∞ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</option>
	  <option value="üì¶">üì¶ –õ—É—Ç</option>
	  <option value="üóùÔ∏è">üóùÔ∏è –ö–ª—é—á–∏</option>
	  <option value="üíæ">üíæ –î–∞–Ω–Ω—ã–µ</option>
	  <option value="üì°">üì° –°–≤—è–∑—å</option>
	  <option value="üîã">üîã –≠–Ω–µ—Ä–≥–∏—è</option>
	  <option value="üí°">üí° –≠–ª–µ–∫—Ç—Ä–∏–∫–∞</option>
      </select>

      <div style="margin-top:8px"><button id="createCategoryBtn" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å</button></div>
    </div>

    <div class="admin-card">
      <h4>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h4>
      <label>–¢—Ä–µ–π–¥–µ—Ä</label>
      <select id="selectTraderForItem"></select>

      <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <select id="selectCategoryForItem"></select>

      <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="newItemName" type="text" />

      <label>Image (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å images/)</label>
      <input id="newItemImage" type="text" value="images/" />

      <label>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (Sell)</label>
      <input id="newItemSell" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 15000" />

      <label>–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ (Buy)</label>
      <input id="newItemBuy" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 10000" />

      <label>–í–∞–ª—é—Ç–∞</label>
      <select id="newItemCurrency">
        <option value="UAH">‚Ç¥ UAH</option>
        <option value="EUR">‚Ç¨ EUR</option>
        <option value="USD">$ USD</option>
      </select>

      <div style="margin-top:8px"><button id="createItemBtn" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button></div>
    </div>

    <div class="admin-card">
      <h4>–£–¥–∞–ª–µ–Ω–∏–µ / JSON</h4>

      <label>–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–π–¥–µ—Ä–∞</label>
      <select id="selectTraderDel"></select>
      <div style="margin-top:6px"><button id="delTraderBtn" class="btn danger">–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–π–¥–µ—Ä–∞</button></div>

      <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

      <label>–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</label>
      <select id="selectTraderDelCat"></select>
      <select id="selectCategoryDel"></select>
      <div style="margin-top:6px"><button id="delCategoryBtn" class="btn danger">–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button></div>

      <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

      <label>–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä</label>
      <select id="selectTraderDelItem"></select>
      <select id="selectCategoryDelItem"></select>
      <select id="selectItemDel"></select>
      <div style="margin-top:6px"><button id="delItemBtn" class="btn danger">–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä</button></div>

      <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

      <div style="margin-top:6px">
        <button id="exportJsonBtn" class="btn">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON</button>
        <div class="note" style="margin-top:8px"><input id="importJsonFile" type="file" accept=".json" /></div>
      </div>
    </div>

  </div>
</div>

<!-- MAIN CONTENT -->
<main class="container" id="content" role="main" aria-live="polite">
  <!-- categories + products rendered here -->
</main>

<!-- LOGIN MODAL -->
<div id="loginModal" class="modal" role="dialog" aria-modal="true">
  <div class="panel">
    <h3 style="margin-top:0">Admin Login</h3>
    <label style="display:block;margin-top:6px">Login</label>
    <input id="loginInput" style="width:100%;padding:8px;margin-top:6px;background:#0b0f13;border:1px solid var(--line);color:var(--text)" />
    <label style="display:block;margin-top:8px">Password</label>
    <input id="passwordInput" type="password" style="width:100%;padding:8px;margin-top:6px;background:#0b0f13;border:1px solid var(--line);color:var(--text)" />
    <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
      <button id="loginCancelBtn" class="btn">Cancel</button>
      <button id="loginOkBtn" class="btn primary">Login</button>
    </div>
    <div id="loginNote" style="margin-top:8px;color:var(--muted);font-size:13px"></div>
  </div>
</div>

<script>
/* ===========================================================
   Full application script (based on your provided file)
   Changes:
   - Added Sell / Buy inputs in admin
   - Items store sell and buy
   - Render displays sell/buy with colored styles
   - Backward compatibility: if item.price exists and sell missing => show price as sell
   =========================================================== */

/* -----------------------------
   Config / State
   ----------------------------- */

const LOGIN_HASH = "84a2079fd93951fc8a5648b8cbf0487f9f24249941bffaa451914cdd51a578e7";
const PASS_HASH  = "56a3c6334c4f42bfb46fa781c763b1c394dc7a6a318ffbac160aa125eae9d0cc";

const DATA_FILE = "data.json";

let data = { traders: [] };
let adminAuth = (sessionStorage.getItem("adminAuth") === "true");
let activeTraderId = localStorage.getItem("activeTraderId") || null;
let playerCurrencyFilter = "ALL";

/* -----------------------------
   DOM refs
   ----------------------------- */

const adminBtn = document.getElementById("adminBtn");
const adminPanelInline = document.getElementById("adminPanelInline");
const traderTabs = document.getElementById("traderTabs");
const contentEl = document.getElementById("content");
const searchInput = document.getElementById("search");
const playerCurrencySelect = document.getElementById("playerCurrency");

const loginModal = document.getElementById("loginModal");
const loginInput = document.getElementById("loginInput");
const passwordInput = document.getElementById("passwordInput");
const loginOkBtn = document.getElementById("loginOkBtn");
const loginCancelBtn = document.getElementById("loginCancelBtn");
const loginNote = document.getElementById("loginNote");

// Admin controls
const createTraderBtn = document.getElementById("createTraderBtn");
const newTraderName = document.getElementById("newTraderName");

const selectTraderForCategory = document.getElementById("selectTraderForCategory");
const newCategoryName = document.getElementById("newCategoryName");
const newCategoryEmoji = document.getElementById("newCategoryEmoji");
const createCategoryBtn = document.getElementById("createCategoryBtn");

const selectTraderForItem = document.getElementById("selectTraderForItem");
const selectCategoryForItem = document.getElementById("selectCategoryForItem");
const newItemName = document.getElementById("newItemName");
const newItemImage = document.getElementById("newItemImage");
const newItemSell = document.getElementById("newItemSell");
const newItemBuy = document.getElementById("newItemBuy");
const newItemCurrency = document.getElementById("newItemCurrency");
const createItemBtn = document.getElementById("createItemBtn");
const saveEditItemBtn = document.getElementById("saveEditItemBtn");

const selectTraderDel = document.getElementById("selectTraderDel");
const delTraderBtn = document.getElementById("delTraderBtn");
const selectTraderDelCat = document.getElementById("selectTraderDelCat");
const selectCategoryDel = document.getElementById("selectCategoryDel");
const delCategoryBtn = document.getElementById("delCategoryBtn");

const selectTraderDelItem = document.getElementById("selectTraderDelItem");
const selectCategoryDelItem = document.getElementById("selectCategoryDelItem");
const selectItemDel = document.getElementById("selectItemDel");
const delItemBtn = document.getElementById("delItemBtn");

const exportJsonBtn = document.getElementById("exportJsonBtn");
const importJsonFile = document.getElementById("importJsonFile");

/* Edit context when editing an item */
let editContext = null; // { traderId, categoryName, itemIndex }

/* -----------------------------
   Helper functions
   ----------------------------- */

function escapeHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

async function sha256Hex(message) {
  const msgUint8 = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

function normalizeImagePath(input) {
  if(!input) return "images/no.png";
  input = String(input).trim();
  if(input.startsWith("images/") || input.startsWith("http://") || input.startsWith("https://")) return input;
  if(input.includes("/")) return input;
  return "images/" + input;
}

function currencySymbol(code) {
  if(code === "UAH") return "‚Ç¥";
  if(code === "EUR") return "‚Ç¨";
  if(code === "USD") return "$";
  return "";
}

/* -----------------------------
   Load data.json (strict)
   ----------------------------- */

function safeFetchJSON(url){
  return fetch(url, { cache: "no-cache" }).then(r=>{
    if(!r.ok) throw new Error("file not found");
    return r.json();
  });
}

async function loadData() {
  try {
    const j = await safeFetchJSON(DATA_FILE);
    if(!j || !Array.isArray(j.traders)) {
      throw new Error("Invalid data.json format. Expecting { traders: [ ... ] }");
    }
    data = j;
    data.traders.forEach((t,i)=>{ if(!t.id) t.id = 'trader-' + i; });
    if(!activeTraderId && data.traders[0]) activeTraderId = data.traders[0].id;
    syncAll();
    render();
  } catch(err) {
    contentEl.innerHTML = `
      <div style="padding:18px;background:#0e0e0f;border:1px solid var(--line);border-radius:8px;color:#f7a;">
        –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ <code>${DATA_FILE}</code>: ${escapeHtml(err.message)}.<br/>
        –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É (Import) –∏–ª–∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª —Ä—è–¥–æ–º —Å —ç—Ç–∏–º html.
      </div>
    `;
    data = { traders: [] };
    syncAll();
  }
}

/* -----------------------------
   UI sync functions (selects, tabs)
   ----------------------------- */

function buildTraderTabs() {
  traderTabs.innerHTML = '';
  if(!data.traders) return;
  data.traders.forEach(tr => {
    const btn = document.createElement('div');
    btn.className = 'trader-tab' + ((tr.id === activeTraderId) ? ' active' : '');
    btn.setAttribute('role','tab');
    btn.textContent = tr.name;
    btn.addEventListener('click', ()=> {
      if(activeTraderId === tr.id) return;
      activeTraderId = tr.id;
      localStorage.setItem('activeTraderId', activeTraderId);
      buildTraderTabs();
      render();
    });
    traderTabs.appendChild(btn);
  });
}

function fillAdminSelects() {
  function fill(selectEl, items){
    if(!selectEl) return;
    selectEl.innerHTML = '';
    items.forEach(it => {
      const opt = document.createElement('option');
      opt.value = it.id || it.name;
      opt.textContent = it.name || it.title || it.id;
      selectEl.appendChild(opt);
    });
    if(selectEl.options.length) selectEl.selectedIndex = 0;
    selectEl.dispatchEvent(new Event('change'));
  }

  const traders = data.traders || [];
  fill(selectTraderForCategory, traders);
  fill(selectTraderForItem, traders);
  fill(selectTraderDel, traders);
  fill(selectTraderDelCat, traders);
  fill(selectTraderDelItem, traders);

  updateCategoriesForSelect(selectTraderForItem, selectCategoryForItem);
  updateCategoriesForSelect(selectTraderDelCat, selectCategoryDel);
  updateCategoriesForSelect(selectTraderDelItem, selectCategoryDelItem);
  updateItemsForDeleteSelect();
}

function updateCategoriesForSelect(traderSelectEl, categorySelectEl){
  const tName = traderSelectEl.value;
  categorySelectEl.innerHTML = "";
  if(!tName) return;
  const trader = data.traders.find(t=>t.id === tName || t.name === tName);
  if(!trader) return;
  trader.categories.forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c.name; opt.textContent = c.name;
    categorySelectEl.appendChild(opt);
  });
  categorySelectEl.dispatchEvent(new Event('change'));
}

function updateItemsForDeleteSelect(){
  selectItemDel.innerHTML = '';
  const tName = selectTraderDelItem.value;
  const cName = selectCategoryDelItem.value;
  if(!tName || !cName) return;
  const trader = data.traders.find(t=>t.id === tName || t.name === tName);
  if(!trader) return;
  const cat = trader.categories.find(c=>c.name === cName);
  if(!cat) return;
  cat.items.forEach(it=>{
    const opt = document.createElement('option');
    opt.value = it.name; opt.textContent = it.name;
    selectItemDel.appendChild(opt);
  });
}

/* -----------------------------
   CRUD Actions for Admin
   ----------------------------- */

function onCreateTrader() {
  const name = newTraderName.value.trim();
  if(!name) { alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ç—Ä–µ–π–¥–µ—Ä–∞'); return; }
  const id = name.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'') || 'trader-' + Date.now();
  if(data.traders.find(t => t.name === name || t.id === id)) {
    alert('–¢—Ä–µ–π–¥–µ—Ä —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
    return;
  }
  data.traders.push({ id, name, categories: [] });
  newTraderName.value = '';
  syncAll();
  render();
}

function onCreateCategory() {
  const tVal = selectTraderForCategory.value;
  const catName = newCategoryName.value.trim();
  const emoji = newCategoryEmoji.value || 'üóÇÔ∏è';
  if(!tVal || !catName){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–π–¥–µ—Ä–∞ –∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'); return; }
  const tr = data.traders.find(t => t.id === tVal || t.name === tVal);
  if(!tr) return;
  if(tr.categories.find(c => c.name === catName)) { alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); return; }
  tr.categories.push({ name: catName, emoji: emoji, items: [] });
  newCategoryName.value = '';
  newCategoryEmoji.selectedIndex = 0;
  syncAll();
  render();
}

function onCreateItem() {
  const tVal = selectTraderForItem.value;
  const catName = selectCategoryForItem.value;
  const name = newItemName.value.trim();
  const sell = (newItemSell.value || '').trim();
  const buy  = (newItemBuy.value  || '').trim();
  const currency = newItemCurrency.value;
  let image = newItemImage.value.trim();

  if(!tVal || !catName || !name){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç—Ä–µ–π–¥–µ—Ä–∞, –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –∏–º—è —Ç–æ–≤–∞—Ä–∞'); return; }
  const tr = data.traders.find(t => t.id === tVal || t.name === tVal);
  if(!tr) return;
  let cat = tr.categories.find(c => c.name === catName);
  if(!cat) {
    cat = { name: catName, items: [] };
    tr.categories.push(cat);
  }
  if(!image) image = 'images/no.png';
  image = normalizeImagePath(image);

  // store sell/buy (strings kept to preserve formatting like "10k")
  cat.items.push({ name, image, sell: sell || '', buy: buy || '', currency: currency || 'UAH' });

  newItemName.value = '';
  newItemImage.value = 'images/';
  newItemSell.value = '';
  newItemBuy.value = '';
  newItemCurrency.selectedIndex = 0;

  syncAll();
  render();
}

function startEditItem(traderId, categoryName, itemIndex) {
  const tr = data.traders.find(t => t.id === traderId || t.name === traderId);
  if(!tr) return;
  const cat = tr.categories.find(c => c.name === categoryName);
  if(!cat) return;
  const item = cat.items[itemIndex];
  if(!item) return;

  selectTraderForItem.value = tr.id || tr.name;
  updateCategoriesForSelect(selectTraderForItem, selectCategoryForItem);
  selectCategoryForItem.value = categoryName;
  newItemName.value = item.name || '';
  newItemImage.value = item.image || 'images/';
  newItemSell.value = item.sell || (item.price || '') || '';
  newItemBuy.value = item.buy || '';
  newItemCurrency.value = item.currency || 'UAH';

  editContext = { traderId: tr.id, categoryName: categoryName, itemIndex: itemIndex };

  createItemBtn.style.display = 'none';
  saveEditItemBtn.style.display = 'inline-block';
}

function onSaveEditItem() {
  if(!editContext) return alert('–ù–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ —Ç–æ–≤–∞—Ä–∞');
  const tr = data.traders.find(t => t.id === editContext.traderId || t.name === editContext.traderId);
  if(!tr) return;
  const cat = tr.categories.find(c => c.name === editContext.categoryName);
  if(!cat) return;
  const item = cat.items[editContext.itemIndex];
  if(!item) return;

  const name = newItemName.value.trim();
  let image = newItemImage.value.trim();
  const sell = (newItemSell.value || '').trim();
  const buy  = (newItemBuy.value || '').trim();
  const currency = newItemCurrency.value;

  if(!name) return alert('–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
  if(!image) image = 'images/no.png';
  image = normalizeImagePath(image);

  item.name = name;
  item.image = image;
  item.sell = sell;
  item.buy = buy;
  item.currency = currency || item.currency;

  editContext = null;
  newItemName.value = '';
  newItemImage.value = 'images/';
  newItemSell.value = '';
  newItemBuy.value = '';
  newItemCurrency.selectedIndex = 0;
  createItemBtn.style.display = 'inline-block';
  saveEditItemBtn.style.display = 'none';

  syncAll();
  render();
}

function onDeleteTrader() {
  const val = selectTraderDel.value;
  if(!val) return;
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–π–¥–µ—Ä–∞ "${val}"?`)) return;
  data.traders = data.traders.filter(t => t.id !== val && t.name !== val);
  if(activeTraderId && !data.traders.find(t => t.id === activeTraderId)) activeTraderId = data.traders[0] ? data.traders[0].id : null;
  syncAll();
  render();
}

function onDeleteCategory() {
  const traderVal = selectTraderDelCat.value;
  const catName = selectCategoryDel.value;
  if(!traderVal || !catName) return;
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${catName}"?`)) return;
  const tr = data.traders.find(t => t.id === traderVal || t.name === traderVal);
  if(!tr) return;
  tr.categories = tr.categories.filter(c => c.name !== catName);
  syncAll();
  render();
}

function onDeleteItem() {
  const tVal = selectTraderDelItem.value;
  const cVal = selectCategoryDelItem.value;
  const itemName = selectItemDel.value;
  if(!tVal || !cVal || !itemName) return;
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä "${itemName}"?`)) return;
  const trader = data.traders.find(t=>t.id===tVal||t.name===tVal);
  if(!trader) return;
  const cat = trader.categories.find(c=>c.name===cVal);
  if(!cat) return;
  cat.items = cat.items.filter(it => it.name !== itemName);
  syncAll();
  render();
}

/* -----------------------------
   Export / Import / Utils
   ----------------------------- */

function onExportJSON() {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "data.json";
  a.click();
}

function onImportJSON(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const parsed = JSON.parse(e.target.result);
      if(!parsed || !Array.isArray(parsed.traders)) throw new Error("Invalid JSON structure");
      data = parsed;
      data.traders.forEach((t,i)=>{ if(!t.id) t.id = 'trader-' + i; });
      if(!activeTraderId && data.traders[0]) activeTraderId = data.traders[0].id;
      syncAll();
      render();
      alert("JSON –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω");
    } catch(err) {
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Çe JSON: " + err.message);
    }
  };
  reader.readAsText(file);
}

/* -----------------------------
   Rendering (categories & products)
   ----------------------------- */

let renderTimer = null;
function renderDebounced() {
  clearTimeout(renderTimer);
  renderTimer = setTimeout(render, 120);
}

function render() {
  contentEl.innerHTML = '';

  if(!activeTraderId) {
    contentEl.innerHTML = '<div style="color:var(--muted)">–ù–µ—Ç —Ç—Ä–µ–π–¥–µ—Ä–æ–≤. –û—Ç–∫—Ä–æ–π –∞–¥–º–∏–Ω–∫—É –∏ –¥–æ–±–∞–≤—å —Ç—Ä–µ–π–¥–µ—Ä–∞ –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ data.json.</div>';
    return;
  }

  const trader = data.traders.find(t => t.id === activeTraderId || t.name === activeTraderId);
  if(!trader) {
    contentEl.innerHTML = '<div style="color:var(--muted)">–ê–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.</div>';
    return;
  }

  const qRaw = (searchInput.value || '').toLowerCase().trim();
  const words = qRaw ? qRaw.split(/\s+/).filter(Boolean) : [];

  let firstMatchCard = null;

  trader.categories.forEach((category, catIndex) => {
    const itemsToShow = (Array.isArray(category.items) ? category.items : []).filter(it => {
      const nameLower = (it.name || '').toLowerCase();
      const nameMatch = words.length ? words.every(w => nameLower.includes(w)) : true;
      const currencyMatch = (playerCurrencyFilter === "ALL") ? true : (it.currency === playerCurrencyFilter);
      return nameMatch && currencyMatch;
    });

    if(itemsToShow.length === 0) return;

    const catBlock = document.createElement('div');
    catBlock.className = 'category';

    const catHead = document.createElement('div');
    catHead.className = 'category-head';

    const leftDiv = document.createElement('div');
    leftDiv.className = 'cat-left';
    const iconSpan = document.createElement('span');
    iconSpan.className = 'cat-icon';
    iconSpan.textContent = (category.emoji || 'üóÇÔ∏è');
    const titleDiv = document.createElement('div');
    titleDiv.className = 'cat-name';
    titleDiv.textContent = category.name;

    leftDiv.appendChild(iconSpan);
    leftDiv.appendChild(titleDiv);

    const countDiv = document.createElement('div');
    countDiv.className = 'cat-count';
    countDiv.textContent = `(${itemsToShow.length})`;

    catHead.appendChild(leftDiv);
    catHead.appendChild(countDiv);

    const catBody = document.createElement('div');
    catBody.className = 'category-body';

    const products = document.createElement('div');
    products.className = 'products';
    products.style.display = 'grid';

    itemsToShow.forEach((it, idx) => {
      const card = document.createElement('div');
      const isSearchActive = words.length > 0;
      card.className = 'card' + (isSearchActive ? ' highlight' : '');
      const img = document.createElement('img');
      img.src = normalizeImagePath(it.image);
      img.alt = it.name || '';

      const nameDiv = document.createElement('div');
      nameDiv.className = 'name';
      nameDiv.textContent = it.name || '';

      // Determine sell & buy with backward compatibility:
      // if it.sell exists use it, else if it.price exists use it as sell
      const sellRaw = (it.sell !== undefined && it.sell !== null && String(it.sell).trim() !== '') ? it.sell : (it.price !== undefined ? it.price : '');
      const buyRaw  = (it.buy  !== undefined && it.buy  !== null && String(it.buy).trim()  !== '') ? it.buy  : '';

      const sellText = sellRaw !== '' ? String(sellRaw) : '‚Äî';
      const buyText  = buyRaw  !== '' ? String(buyRaw)  : '‚Äî';
      const curSym = currencySymbol(it.currency || '');

      const metaDiv = document.createElement('div');
      metaDiv.className = 'price';
      metaDiv.innerHTML = `<span class="price-sell">Sell: ${escapeHtml(sellText)} ${escapeHtml(curSym)}</span>
                           <span class="price-sep">|</span>
                           <span class="price-buy">Buy: ${escapeHtml(buyText)} ${escapeHtml(curSym)}</span>`;

      card.appendChild(img);
      card.appendChild(nameDiv);
      card.appendChild(metaDiv);

      products.appendChild(card);

      if(!firstMatchCard && isSearchActive) firstMatchCard = card;
    });

    catBody.appendChild(products);
    catBlock.appendChild(catHead);
    catBlock.appendChild(catBody);
    contentEl.appendChild(catBlock);

    catHead.addEventListener('click', () => {
      catBody.style.display = catBody.style.display === 'block' ? 'none' : 'block';
    });

    if(words.length) catBody.style.display = 'block';
    else catBody.style.display = 'none';
  });

  if(firstMatchCard) {
    setTimeout(()=> {
      try { firstMatchCard.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(e) {}
    }, 80);
  }
}

/* -----------------------------
   Sync all UI pieces
   ----------------------------- */
function syncAll() {
  data.traders = data.traders || [];
  data.traders.forEach((t,i)=>{ if(!t.id) t.id = 'trader-' + i; });

  if(!activeTraderId && data.traders.length) activeTraderId = data.traders[0].id;

  buildTraderTabs();
  fillAdminSelects();

  updateCategoriesForSelect(selectTraderForItem, selectCategoryForItem);
  updateCategoriesForSelect(selectTraderDelItem, selectCategoryDelItem);
  updateCategoriesForSelect(selectTraderDelCat, selectCategoryDel);
}

/* -----------------------------
   Event wiring
   ----------------------------- */

adminBtn.addEventListener('click', () => {
  if(!adminAuth) {
    loginModal.style.display = 'flex';
    loginInput.value = '';
    passwordInput.value = '';
    setTimeout(()=> loginInput.focus(), 50);
    return;
  }
  adminPanelInline.style.display = adminPanelInline.style.display === 'block' ? 'none' : 'block';
});

loginCancelBtn.addEventListener('click', ()=>{ loginModal.style.display = 'none'; });
loginOkBtn.addEventListener('click', async () => {
  const u = (loginInput.value || '').trim();
  const p = (passwordInput.value || '').trim();
  if(!u || !p) { loginNote.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å'; return; }
  try {
    const uh = await sha256Hex(u);
    const ph = await sha256Hex(p);
    if(uh === LOGIN_HASH && ph === PASS_HASH) {
      adminAuth = true;
      sessionStorage.setItem('adminAuth','true');
      loginModal.style.display = 'none';
      adminPanelInline.style.display = 'block';
      syncAll();
    } else {
      loginNote.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
    }
  } catch(err) {
    loginNote.textContent = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
  }
});

searchInput.addEventListener('input', renderDebounced);
playerCurrencySelect.addEventListener('change', (e) => {
  playerCurrencyFilter = e.target.value;
  render();
});

createTraderBtn.addEventListener('click', onCreateTrader);
createCategoryBtn.addEventListener('click', onCreateCategory);
createItemBtn.addEventListener('click', onCreateItem);
saveEditItemBtn && saveEditItemBtn.addEventListener('click', onSaveEditItem);
delTraderBtn.addEventListener('click', onDeleteTrader);
delCategoryBtn.addEventListener('click', onDeleteCategory);
delItemBtn.addEventListener('click', onDeleteItem);
exportJsonBtn.addEventListener('click', onExportJSON);
importJsonFile.addEventListener('change', (evt) => {
  const f = evt.target.files && evt.target.files[0];
  if(f) onImportJSON(f);
});

selectTraderForItem.addEventListener('change', ()=> updateCategoriesForSelect(selectTraderForItem, selectCategoryForItem));
selectTraderDelCat.addEventListener('change', ()=> updateCategoriesForSelect(selectTraderDelCat, selectCategoryDel));
selectTraderDelItem.addEventListener('change', ()=> updateCategoriesForSelect(selectTraderDelItem, selectCategoryDelItem));
selectCategoryDelItem.addEventListener('change', updateItemsForDeleteSelect);

/* -----------------------------
   Startup
   ----------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  syncAll();
});
</script>

<!-- FOOTER DISCLAIMER (ADDED) -->
<footer class="site-disclaimer" style="margin-top:40px;padding:16px;border-top:1px solid #2a313a;background:#0d1114;color:#9aa0aa;font-size:13px;line-height:1.5;text-align:center;">
  <strong style="color:#e6e6e6;">–î–∏—Å–∫–ª–µ–π–º–µ—Ä</strong><br>
  –°–æ–∑–¥–∞—Ç–µ–ª—å —Å–∞–π—Ç–∞: <strong style="color:#e6e6e6;">matius</strong>.<br>
  –ö–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º –∏ –º–æ–∂–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è, –∏–∑–º–µ–Ω—è—Ç—å—Å—è –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—Ç—å—Å—è –ª—é–±—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º.<br>
  –î–∞–Ω–Ω—ã–π —Å–∞–π—Ç <strong style="color:#e6e6e6;">–Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º</strong> –∏ <strong style="color:#e6e6e6;">–Ω–∏–∫–∞–∫ –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è</strong> –∫ —Å–µ—Ä–≤–µ—Ä—É <strong style="color:#e6e6e6;">STALKER ZONE</strong>.<br>
  –ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ —Ä–∞–º–∫–∞—Ö –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã –∏–≥—Ä–æ–∫–æ–≤.
</footer>

</body>
</html>
